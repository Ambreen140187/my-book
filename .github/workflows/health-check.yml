name: Health Check - API and Website

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allows manual trigger

jobs:
  backend-health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check backend API status
      run: |
        # Check if backend is responding (replace with actual backend URL)
        BACKEND_URL="${{ secrets.BACKEND_URL || 'https://your-backend-deployment-url.com' }}"

        if [ -n "$BACKEND_URL" ]; then
          echo "Checking backend health at: $BACKEND_URL"
          response=$(curl -s -o /dev/null -w "%{http_code}" $BACKEND_URL/health)
          echo "Health check response code: $response"

          if [ $response -eq 200 ]; then
            echo "✅ Backend is healthy"
          else
            echo "❌ Backend may have issues, HTTP code: $response"
            exit 1
          fi
        else
          echo "No backend URL configured, skipping health check"
        fi

    - name: Test API endpoint
      run: |
        BACKEND_URL="${{ secrets.BACKEND_URL || 'https://your-backend-deployment-url.com' }}"

        if [ -n "$BACKEND_URL" ] && [ "$BACKEND_URL" != "https://your-backend-deployment-url.com" ]; then
          # Test the /ask endpoint with a simple question
          response=$(curl -s -X POST $BACKEND_URL/ask \
            -H "Content-Type: application/json" \
            -d '{"question": "Hello", "selected_text": null}')

          echo "API test response: $response"

          if echo "$response" | grep -q "answer\|message"; then
            echo "✅ API endpoint is working correctly"
          else
            echo "❌ API endpoint may have issues"
            exit 1
          fi
        fi

  frontend-health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Check frontend status
      run: |
        # Check if frontend is responding (replace with actual frontend URL)
        FRONTEND_URL="${{ secrets.FRONTEND_URL || 'https://your-frontend-deployment-url.com' }}"

        if [ -n "$FRONTEND_URL" ]; then
          echo "Checking frontend health at: $FRONTEND_URL"
          response=$(curl -s -o /dev/null -w "%{http_code}" $FRONTEND_URL)
          echo "Frontend response code: $response"

          if [ $response -eq 200 ]; then
            echo "✅ Frontend is accessible"
          else
            echo "❌ Frontend may have issues, HTTP code: $response"
            exit 1
          fi
        else
          echo "No frontend URL configured, skipping health check"
        fi

    - name: Check chatbot functionality
      run: |
        FRONTEND_URL="${{ secrets.FRONTEND_URL || 'https://your-frontend-deployment-url.com' }}"

        if [ -n "$FRONTEND_URL" ] && [ "$FRONTEND_URL" != "https://your-frontend-deployment-url.com" ]; then
          # Check if the page contains the chatbot element
          response=$(curl -s $FRONTEND_URL)

          if echo "$response" | grep -q "chatbot-button\|floating-chat\|ai-chat"; then
            echo "✅ Chatbot element found on frontend"
          else
            echo "⚠️ Chatbot element not found, but frontend is accessible"
          fi
        fi

  notify-health-status:
    runs-on: ubuntu-latest
    needs: [backend-health-check, frontend-health-check]
    if: always()

    steps:
    - name: Send health check notification
      run: |
        if [[ "${{ needs.backend-health-check.result }}" == "success" ]] && [[ "${{ needs.frontend-health-check.result }}" == "success" ]]; then
          echo "✅ All services are healthy"
          echo "All systems operational"
        elif [[ "${{ needs.backend-health-check.result }}" == "failure" ]] || [[ "${{ needs.frontend-health-check.result }}" == "failure" ]]; then
          echo "❌ Some services have issues"
          echo "Please check the deployment status"
          exit 1
        else
          echo "⚠️ Health check completed with warnings"
        fi

  dependency-update-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Check for outdated dependencies in frontend
      run: |
        cd ai-native-book-website
        npm outdated || echo "Dependency check completed"

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Check for outdated dependencies in backend
      run: |
        cd backend
        pip list --outdated || echo "Dependency check completed"